name: CI - Build All Platforms

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-info:
    name: Build Information
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        
      - name: Generate build info
        run: |
          echo "### UNAudio Build :musical_note:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Platforms:**" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ¤– Android (AAudio API)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ iOS (CoreAudio)" >> $GITHUB_STEP_SUMMARY

  lint-code:
    name: Lint Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        
      - name: Check C++ code formatting
        run: |
          echo "Checking C++ code style..."
          # Check for basic code quality issues
          
          # Check for tab characters (should use spaces)
          if grep -r $'\t' --include="*.cpp" --include="*.h" --include="*.mm" NativeSource/; then
            echo "âš ï¸  Warning: Found tab characters in source files"
          fi
          
          # Check for trailing whitespace
          if grep -r ' $' --include="*.cpp" --include="*.h" --include="*.mm" NativeSource/; then
            echo "âš ï¸  Warning: Found trailing whitespace"
          fi
          
          echo "âœ… Basic code checks passed"

  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    needs: lint-code
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        
      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'
          
      - name: Setup Android SDK
        uses: android-actions/setup-android@v2
        
      - name: Install NDK
        run: |
          echo "y" | sdkmanager "ndk;25.1.8937393"
          echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/25.1.8937393" >> $GITHUB_ENV
          
      - name: Cache Gradle
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*') }}
          
      - name: Build Android native library
        run: |
          cd Plugins/Android
          chmod +x gradlew
          ./gradlew assembleRelease --stacktrace
          
      - name: Upload Android artifacts
        uses: actions/upload-artifact@v3
        with:
          name: android-libs
          path: Plugins/Android/unaudio/build/intermediates/cmake/release/obj/**/*.so
          
  build-ios:
    name: Build iOS
    runs-on: macos-latest
    needs: lint-code
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        
      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_14.2.app/Contents/Developer
        
      - name: Build iOS native library
        run: |
          mkdir -p Build/iOS
          cd Build/iOS
          
          # Build device library
          clang++ -c \
            -arch arm64 \
            -isysroot $(xcrun --sdk iphoneos --show-sdk-path) \
            -mios-version-min=11.0 \
            -O3 \
            -fvisibility=hidden \
            -I../../NativeSource/Core \
            ../../NativeSource/iOS/UNAudioIOS.mm \
            -o UNAudioIOS_arm64.o
          
          ar rcs libUNAudio_arm64.a UNAudioIOS_arm64.o
          
      - name: Upload iOS artifacts
        uses: actions/upload-artifact@v3
        with:
          name: ios-libs
          path: Build/iOS/libUNAudio*.a
          
  test-documentation:
    name: Test Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        
      - name: Check documentation files
        run: |
          echo "Checking documentation..."
          
          required_docs=(
            "README.md"
            "Documentation/AndroidSetup.md"
            "Documentation/iOSSetup.md"
          )
          
          for doc in "${required_docs[@]}"; do
            if [ -f "$doc" ]; then
              echo "âœ… Found $doc"
            else
              echo "âŒ Missing $doc"
              exit 1
            fi
          done
          
          echo "âœ… All required documentation present"
          
      - name: Validate markdown
        run: |
          echo "Checking markdown syntax..."
          # Check for broken links (basic check)
          grep -r '\[.*\]()' --include="*.md" . && exit 1 || echo "âœ… No empty links found"

  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-android, build-ios, test-documentation]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "## Build Complete! :tada:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All platform builds completed successfully." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Download build artifacts" >> $GITHUB_STEP_SUMMARY
          echo "2. Test on physical devices" >> $GITHUB_STEP_SUMMARY
          echo "3. Measure latency performance" >> $GITHUB_STEP_SUMMARY
          echo "4. Ready for integration!" >> $GITHUB_STEP_SUMMARY
